{% extends "base.html" %}
{% load static %}
{% block title %}Chat - Booking #{{ booking.id }}{% endblock %}

{% block content %}
<section class="container" style="max-width: 720px; margin: 1rem auto;">
  <h2 class="text-xl font-semibold mb-2">Chat for Ride: {{ booking.ride_request.pickup_location }} â†’ {{ booking.ride_request.dropoff_location }}</h2>
  <p class="text-sm text-gray-600 mb-4">Participants: <strong>{{ booking.ride_request.customer.username }}</strong> and <strong>{{ booking.driver.username }}</strong></p>

  <div id="chatBox" class="card" style="max-height: 420px; overflow-y: auto; padding: 1rem; background: #fafafa; border: 1px solid #e5e7eb; border-radius: .5rem;">
    {% for m in messages_list %}
      <div class="mb-2">
        <span class="text-xs text-gray-500">{{ m.created_at|date:"Y-m-d H:i" }}</span>
        <p class="m-0"><strong>{{ m.sender.username }}:</strong> {{ m.text|linebreaksbr }}</p>
      </div>
    {% empty %}
      <p class="text-gray-500">No messages yet.</p>
    {% endfor %}
  </div>

  <form method="post" action="{% url 'chat_room' booking.id %}" class="mt-3">
    {% csrf_token %}
    <div class="flex items-center gap-2">
      <input type="text" name="text" class="form-input" placeholder="Type your message..." required />
      <button class="btn btn-primary" type="submit">Send</button>
      <a class="btn" href="{% url 'chat_room' booking.id %}">Refresh</a>
    </div>
  </form>

  <div class="mt-4">
    <a class="text-blue-600 underline" href="{% if is_driver %}{% url 'driver_dashboard' %}{% else %}{% url 'customer_dashboard' %}{% endif %}">Back to Dashboard</a>
  </div>
</section>

{% block extra_scripts %}
<script>
 
  setTimeout(function(){ window.location.reload(); }, 15000);
 
  const box = document.getElementById('chatBox');
  if (box) { box.scrollTop = box.scrollHeight; }
</script>
{% endblock %}
{% endblock %}
