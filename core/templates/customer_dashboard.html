{% extends "base.html" %}
{% load static %}
{% block title %}Customer Dashboard - Rent a Driver{% endblock %}

{% block content %}
<section class="dashboard">
  <div class="customer-dashboard container">
   
   
  <h2 class="welcome-title">Welcome, {{ request.user.username }} üëã</h2>

    
    <div class="dashboard-grid">

      
      <div class="card rides-card enhanced-rides">
        <div class="card-header">
          <h3>üìã My Ride Requests</h3>
          <p class="card-subtitle">Track your current and past ride requests</p>
        </div>
       
        <div class="rides-container">
          <ul class="rides-list">
            {% for r in rides %}
              <li>
                <div>
                  <strong>{{ r.pickup_location }}</strong> ‚Üí {{ r.dropoff_location }}
                  <small>¬∑ {{ r.created_at|date:"Y-m-d H:i" }} ¬∑ {{ r.status|title }}</small>
                </div>
                {% if r.booking and r.booking.status != 'completed' and r.booking.status != 'cancelled' %}
                  <div style="margin:.25rem 0;">
                    <a class="btn btn-secondary" href="{% url 'chat_room' r.booking.id %}">üí¨ Chat</a>
                  </div>
                {% endif %}
                {% if r.status == 'pending' %}
                  <a class="btn btn-secondary" href="{% url 'edit_ride_request' r.id %}">Edit</a>
                  <form method="post" action="{% url 'cancel_ride_request' r.id %}" style="display:inline-block;">
                    {% csrf_token %}
                    <button class="btn btn-secondary">Cancel</button>
                  </form>
                {% elif r.status != 'completed' and r.status != 'cancelled' %}
                  <form method="post" action="{% url 'cancel_ride_request' r.id %}">
                    {% csrf_token %}
                    <button class="btn btn-secondary">Cancel</button>
                  </form>
                {% endif %}
              </li>
            {% empty %}
              <li>No ride requests yet.</li>
            {% endfor %}
          </ul>
         
          <div class="empty-state" {% if rides %}style="display:none;"{% endif %}>
            <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 12l2 2 4-4"/>
              <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
              <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
              <path d="M3 12h6m6 0h6"/>
            </svg>
            <h4>No ride requests yet</h4>
            <p>Create your first ride request to get started!</p>
          </div>
        </div>

        
        <div class="rating-form enhanced-rating" data-booking="BOOKING_ID" style="display: none;">
          <div class="rating-header">
            <h4>Rate Your Experience</h4>
            <p>Help other customers by sharing your feedback</p>
          </div>
         
          <div class="rating-content">
            <label class="rating-label">Rate your driver:</label>
            <select class="rating-select">
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Very Good</option>
              <option value="3">‚≠ê‚≠ê‚≠ê Good</option>
              <option value="2">‚≠ê‚≠ê Fair</option>
              <option value="1">‚≠ê Poor</option>
            </select>
           
            <label class="feedback-label">Additional feedback (optional):</label>
            <textarea class="feedback-input" placeholder="Share your experience with this driver..." rows="3"></textarea>
           
            <button class="btn submit-review btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
              Submit Review
            </button>
          </div>
        </div>
      </div>

     
      <div class="card">
        <div class="card-header">
          <h3>‚≠ê Reviews</h3>
          <p class="card-subtitle">Leave a review for completed rides</p>
        </div>
        <ul class="rides-list">
          {% for b in customer_bookings %}
            {% if b.status == 'completed' %}
              <li>
                <div>
                  <strong>Ride:</strong> {{ b.ride_request.pickup_location }} ‚Üí {{ b.ride_request.dropoff_location }}
                  <small>¬∑ {{ b.confirmed_at|date:"Y-m-d H:i" }}</small>
                </div>
                {% if not b.review %}
                  <form method="post" action="{% url 'create_review' b.id %}" class="inline" enctype="multipart/form-data">
                    {% csrf_token %}
                    <label>Rating:</label>
                    <select name="rating">
                      <option value="5">5</option>
                      <option value="4">4</option>
                      <option value="3">3</option>
                      <option value="2">2</option>
                      <option value="1">1</option>
                    </select>
                    <input type="text" name="feedback" placeholder="Feedback (optional)" />
                    <input type="file" name="image" accept="image/*" />
                    <button class="btn btn-primary">Submit</button>
                  </form>
                {% else %}
                  <p>Review submitted: ‚≠ê {{ b.review.rating }} ‚Äî {{ b.review.feedback|default:"No feedback" }}
                    {% if b.review.image %}
                      <br/>
                      <img src="{{ b.review.image.url }}" alt="Review image" style="max-width:200px;max-height:200px;margin-top:.25rem;border-radius:6px;object-fit:cover;" />
                    {% endif %}
                    <form method="post" action="{% url 'delete_review' b.review.id %}" style="display:inline; margin-left:.5rem;">
                      {% csrf_token %}
                      <button class="btn btn-secondary">Delete Review</button>
                    </form>
                  </p>
                {% endif %}
              </li>
            {% endif %}
          {% empty %}
            <li>No bookings yet.</li>
          {% endfor %}
        </ul>
      </div>

     
      <div class="card create-card enhanced-form">
        <div class="form-header">
          <h3>üöó Create a Ride Request</h3>
          <p class="form-subtitle">Fill in the details for your ride request</p>
        </div>
       
        <form method="post" action="{% url 'customer_dashboard' %}" class="ride-request-form">
          {% csrf_token %}
          <div class="form-group">
            <label for="pickup" class="form-label">
              <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
              Pickup Location
            </label>
            <input type="text" name="pickup" class="form-input" placeholder="Enter your pickup address" required />
          </div>

          <div class="form-group">
            <label for="dropoff" class="form-label">
              <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              Dropoff Location
            </label>
            <input type="text" name="dropoff" class="form-input" placeholder="Enter your destination address" required />
          </div>

          <div class="form-group">
            <label for="carName" class="form-label">
              <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              Your Car Details
            </label>
            <input type="text" name="carName" class="form-input" placeholder="e.g., Honda Civic, Toyota Camry" required />
            <small class="form-help">Please provide your car make and model</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large w-100">
              <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
              Create Ride Request
            </button>
          </div>
        </form>
       
        {% if messages %}
          <ul class="msg mt-3">{% for message in messages %}<li>{{ message }}</li>{% endfor %}</ul>
        {% endif %}
      </div>

    </div>

   
    <div class="card nearby-card">
      <div class="card-header">
        <h3>üöó Nearby Drivers (within 10 km)</h3>
        <p class="card-subtitle">Find drivers near your pickup area</p>
      </div>
      <div class="mb-3 text-sm text-gray-700">
        {% if request.user.last_lat and request.user.last_lng %}
          <p>Your saved location: {{ request.user.last_lat }}, {{ request.user.last_lng }}</p>
        {% else %}
          <p>No saved location yet. Use the button below to set your current location.</p>
        {% endif %}
      </div>
      <form id="locationForm" action="{% url 'update_location' %}" method="post" class="mb-4">
        {% csrf_token %}
        <input type="hidden" name="next" value="{% url 'customer_dashboard' %}">
        <div class="flex items-center gap-2">
          <input id="latInput" type="text" name="lat" placeholder="Latitude" class="form-input" required>
          <input id="lngInput" type="text" name="lng" placeholder="Longitude" class="form-input" required>
          <button class="btn btn-secondary" type="submit">Save Location</button>
          <button class="btn" type="button" id="geoBtn">Use my location</button>
        </div>
        <small class="text-gray-500">Enter your coordinates. We‚Äôll show drivers within 10 km.</small>
      </form>
      <ul class="rides-list">
        {% for d in nearby_drivers %}
          <li>
            <strong>{{ d.user.username }}</strong> ‚Äî {{ d.vehicle_details }}
            {% if d.distance_km is not None %}
              <small>¬∑ {{ d.distance_km }} km away</small>
            {% endif %}
          </li>
        {% empty %}
          <li>No nearby drivers available.</li>
        {% endfor %}
      </ul>
    </div>

  </div>
</section>

<script>
  
  document.addEventListener('DOMContentLoaded', function() {
    const dashboardNav = document.getElementById('navDashboard');
    if (dashboardNav) {
      dashboardNav.classList.add('active');
    }

   
    const geoBtn = document.getElementById('geoBtn');
    const latEl = document.getElementById('latInput');
    const lngEl = document.getElementById('lngInput');
    const form = document.getElementById('locationForm');
    if (geoBtn && latEl && lngEl && form) {
      geoBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser.');
          return;
        }
        geoBtn.disabled = true;
        const originalText = geoBtn.textContent;
        geoBtn.textContent = 'Detecting‚Ä¶';
        navigator.geolocation.getCurrentPosition(function(pos) {
          const { latitude, longitude } = pos.coords;
          latEl.value = latitude.toFixed(6);
          lngEl.value = longitude.toFixed(6);
          geoBtn.textContent = 'Detected ‚úì';
          form.submit();
        }, function(err) {
          alert('Could not get location: ' + err.message);
          geoBtn.disabled = false;
          geoBtn.textContent = originalText;
        }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
      });
    }
  });
</script>  

{% endblock %}
